% kthpq-thesis is marked CC0 1.0 Universal. To view a copy of this mark,
% visit https://creativecommons.org/publicdomain/zero/1.0/
%
% Extension of the biblatex package for the kthpq-thesis class.
%
% This package loads the full journal title field, provides the macros
% - \inlinepaper
% - \displaypaper
% and a counter, \paper.
%
% This package requires the auxiliary packages kthpq-font and
% kthpq-color.

\DeclareOption*{\PassOptionsToPackage{\CurrentOption}{biblatex}}

\PassOptionsToPackage{datamodel=kthpq/fjournal}{biblatex}

\ProcessOptions\relax

\RequirePackage{biblatex}
\RequirePackage{afterpage}

\RequirePackage{kthpq/kthpq-font}
\RequirePackage{kthpq/kthpq-color}

% Add fjournaltitle field
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map{
      \step[fieldsource=fjournal, fieldtarget=fjournaltitle]
    }
  }
}
\DeclareFieldFormat{fjournaltitle}{\mkbibemph{#1\isdot}}% copy journaltitle format

\def\defaultmisctext{Preprint}
\let\@misctext\defaultmisctext

% ---- inline paper ----
% Usage: \inlinepaper[misctext=Preprint]{<ref>}
\newcommand\inlinepaper[2][]{%
  \setkeys{kthpq@inlinepaper}{#1}
  \@inlinepaper{#2}
  \let\@misctext\defaultmisctext%
}

\define@key{kthpq@inlinepaper}{misctext}{\def\@misctext{#1}}

\DeclareCiteCommand{\@inlinepaper}
  {%
    \pagetrackerfalse%
    \citetrackerfalse%
    \usebibmacro{prenote}%
    \defcounter{maxnames}{99}%
    \sffamily%
  }
  {%
    \textbf{\printfield{labeltitle}.}
    \printnames{author}.
    \ifentrytype{article}{%
      In \usebibmacro{tryfjournal},
    }{}%
    \ifentrytype{inbook}{%
      In \printfield{booktitle},
    }{}%
    \ifentrytype{incollection}{%
      In \printfield{booktitle},
    }{}%
    \ifentrytype{inproceedings}{%
      In \printfield{booktitle},
    }{}%
    \ifentrytype{misc}{%
      \@misctext\ifx\@misctext\empty\else, \fi%
    }{}%
    \printfield{year}.
    \printfield{doi}\printfield[eprint:arxiv]{eprint}%
  }
  {}
  {%
    \usebibmacro{postnote}%
  }

\newbibmacro{tryfjournal}{%
  \iffieldundef{fjournaltitle}{%
    \printfield{journaltitle}%
  }{%
    \printfield{fjournaltitle}%
  }%
}
% ---- end inline paper ----

\newcounter{paper}

% ---- paper title page ----
% Usage: \papertitlepage[color=white,misctext=Preprint]{<ref>}
\newcommand{\papertitlepage}[2][]{%
  \cleardoublepage%
  \newgeometry{top=50mm,bottom=30mm,left=43mm,right=22mm}%
  \thispagestyle{empty}%
  \setkeys{kthpq@papertitlepage}{#1}
  \afterpage{\nopagecolor}% Reset the color after the current page
  \phantomsection
  \stepcounter{paper}
  \addcontentsline{toc}{chapter}{\protect\numberline{\Alph{paper}}\texorpdfstring{\papertitle{#2}}{\Alph{paper}#2}}%
  \@papertitlepage{#2}
  \renewcommand{\thechapter}{\Alph{paper}}
  \markboth{}{}% Reset header
  \let\@misctext\defaultmisctext
  \restoregeometry
  \newpage
}

% Using the built-in keyval package: https://tex.stackexchange.com/a/34314/216213
\define@key{kthpq@papertitlepage}{color}{\pagecolor{#1}}
\define@key{kthpq@papertitlepage}{misctext}{\def\@misctext{#1}}

% Inner formatting of the paper cover page
\DeclareCiteCommand{\@papertitlepage}
  {%
    \pagetrackerfalse%
    \citetrackerfalse%
    \defcounter{maxnames}{99}%
    \raggedright%
  }
  {%
    \par\vspace*{5mm}
    {\Huge\noindent\sffamily\bfseries Paper~\Alph{paper}\par}
    \vspace{10mm}
    {\Large\noindent\sffamily\bfseries\printfield{labeltitle}\par}
    \vspace{10mm}
    {\uppersf\printnames{author}\par}
    \vspace{10mm}
    \ifentrytype{article}{%
      In \usebibmacro{tryfjournal},
    }{}%
    \ifentrytype{inbook}{%
      In \printfield{booktitle},
    }{}%
    \ifentrytype{incollection}{%
      In \printfield{booktitle},
    }{}%
    \ifentrytype{inproceedings}{%
      In \printfield{booktitle},
    }{}%
    \ifentrytype{misc}{%
      \@misctext\ifx\@misctext\empty\else, \fi%
    }{}%
    \printfield{year}.%
    % \printfield[eprint:arxiv]{eprint}% maybe?
  }
  {}
  {}
% ---- end paper title page ----

% Usage: \papertitle{<ref>}
\DeclareCiteCommand{\papertitle}{}{\printfield{labeltitle}}{}{}

% Usage: \paperchapter[<short title>]{<ref>}
\newcommand\paperchapter[2][\@nil]{%
  \ifx#1\@nil
    \@paperchapter{Paper\ \Alph{paper}.\ \papertitle{#2}}{\papertitle{#2}}%
  \else
    \@paperchapter{Paper\ \Alph{paper}.\ #1}{\papertitle{#2}}%
  \fi%
}

\def\@paperchapter#1#2{%
  \markboth{\uppersf#1}{}%
  \chapter*{#2}%
  \renewcommand{\thesection}{\arabic{section}}%
}